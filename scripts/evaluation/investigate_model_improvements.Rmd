---
title: "Investigating model improvements"
author: "TMM"
date: "2022-08-03"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(include = FALSE, echo = FALSE, fig.width = 10, message = FALSE, warning = FALSE)

library(tidyverse)
library(ggridges)
library(patchwork)

write = FALSE

```


```{r data, echo = FALSE}

obvs_df <- read.csv('../../outputs/v4Community/v4n_new_obvs_perc_increase_1_50_spp50.csv', 
                    stringsAsFactors = FALSE)

# load each of the evaluation files 
cdf_0.1_uptake <- read.csv('../../outputs/v4Community/asv1_v4combined_outputs_comm1_50_spp50.csv', 
                           stringsAsFactors = FALSE) %>%
  mutate(uptake = '0.1',
         asv = 'asv1')
cdf_0.01_uptake <- read.csv('../../outputs/v4Community/asv2_v4combined_outputs_comm1_50_spp50.csv', 
                            stringsAsFactors = FALSE) %>%
  mutate(uptake = '0.01',
         asv = 'asv2')

cdf_0.5_uptake <- read.csv('../../outputs/v4Community/asv4_v4combined_outputs_comm1_50_spp50.csv', 
                           stringsAsFactors = FALSE) %>%
  mutate(uptake = '0.5',
         asv = 'asv4')

cdf_0_uptake <- read.csv('../../outputs/v4Community/asv3_v4combined_outputs_comm1_50_spp50.csv', 
                         stringsAsFactors = FALSE) %>%
  mutate(uptake = '0',
         asv = 'asv3')

# combine all the files
cdf <- rbind(cdf_0_uptake, cdf_0.1_uptake,cdf_0.01_uptake,cdf_0.5_uptake)

```


```{r calculate_differences}

init_tab <- cdf[cdf$method =='initial',]
colnames(init_tab) <- paste0('initial_', colnames(init_tab))
et <- cdf

et$init_mse <- init_tab$initial_mse[match(paste0(et$species, et$community),
                                          paste0(init_tab$initial_species, init_tab$initial_community))]
et$init_corr <- init_tab$initial_corr[match(paste0(et$species, et$community),
                                            paste0(init_tab$initial_species, init_tab$initial_community))]
et$init_auc <- init_tab$initial_auc[match(paste0(et$species, et$community),
                                          paste0(init_tab$initial_species, init_tab$initial_community))]
et$init_mean_sd <- init_tab$initial_mean_sd[match(paste0(et$species, et$community),
                                                  paste0(init_tab$initial_species, init_tab$initial_community))]
et$init_max_sd <- init_tab$initial_max_sd[match(paste0(et$species, et$community),
                                                paste0(init_tab$initial_species, init_tab$initial_community))]


## get differences
et <- et %>% 
  mutate(delta_mse = mse - init_mse,
         delta_corr = corr - init_corr,
         delta_auc = auc - init_auc,
         delta_mean_sd = mean_sd - init_mean_sd,
         delta_max_sd = max_sd - init_max_sd)

```

```{r cut_func}


# # function to cut data into equal numbers and return the correct labels (min and max of the group) 
# ntile_cut <- function(cdat, ngroups = 10, rounding = 4, return_df = FALSE) {
#   
#   # get the groups
#   cats <- dplyr::ntile(cdat, ngroups)
#   
#   # convert into data frame
#   outdf <- data.frame(cdat,cats)
#   
#   # get the values (min+max for each group) and create labels for the group
#   cat_labels <- tapply(outdf$cdat, outdf$cats, 
#                        FUN = function(x) paste(round(min(x),rounding), round(max(x), rounding), sep = '_'))
#   
#   # convert to data frame for matching
#   cats_df <- data.frame(grp=1:ngroups,cat_labels)
#   
#   # bind the data frame and the groups
#   outdf$cat_labels <- cats_df$cat_labels[match(outdf$cats, cats_df$grp)]
#   
#   if(return_df) {return(outdf)} else {return(outdf$cat_labels)}
#   
# }


```


## Improvements due to increases in observations

```{r load_obs}

## load all the observations for a given community 
asv1 <- read_csv('../../outputs/v4Community/asv1_v4all_observations.csv') %>% 
  mutate(uptake = 0.1,
         asv = 'asv1')
asv2 <- read_csv('../../outputs/v4Community/asv2_v4all_observations.csv') %>% 
  mutate(uptake = 0.01,
         asv = 'asv2')
asv3 <- read_csv('../../outputs/v4Community/asv3_v4all_observations.csv') %>% 
  mutate(uptake = 0,
         asv = 'asv3')
asv4 <- read_csv('../../outputs/v4Community/asv4_v4all_observations.csv') %>% 
  mutate(uptake = 0.5,
         asv = 'asv4')

df <- rbind(asv1,asv2,asv3,asv4)

# initial locations
init_nona <- df[which(df$method == 'initial'),]

# all others
meths <- df#[df$method != 'initial',]

# remove initial locations - only looking at new locations
new_locs <- meths[!meths$id %in% init_nona$id,] ## id is lon lat id

# initial locations for each species
sp_init_locs <- init_nona %>% 
  # na.omit() %>% 
  group_by(method, community, species, prevalence, asv, uptake) %>% 
  summarise(n = sum(Observed, na.rm = T)) %>% 
  mutate(id = paste(community, species, prevalence, asv, uptake, sep = '_'))

# new locations for each species
sp_new_locs <- new_locs %>% 
  # na.omit() %>% 
  group_by(method, community, species, prevalence, asv, uptake) %>% 
  summarise(n = sum(Observed)) %>% 
  mutate(id = paste(community, species, prevalence, asv, uptake, sep = '_'))

# bind the two together
init_new_locs <- sp_new_locs %>% 
  rowwise() %>% 
  mutate(n_init_obs = sp_init_locs$n[match(id, sp_init_locs$id)],
         id2 = paste(community, method, species, prevalence, asv, uptake, sep = '_'))

# ggplot(init_new_locs, aes(x = n_init_obs, y = n, col = method)) +
#   # geom_point() +
#   geom_smooth() +
#   ylab('n new observations') + xlab('n initial observations')

# head(init_new_locs)

```


```{r set_perc_change}

p_c <- 5

```


```{r match_to_et}

nobvs_pl <- et %>% 
  mutate(id = paste(community, method, species, prevalence, asv, uptake, sep = '_'),
         obvs_init = init_new_locs$n_init_obs[match(id, init_new_locs$id2)],
         new_obvs = init_new_locs$n[match(id, init_new_locs$id2)],
         nobvs_cat = dplyr::ntile(new_obvs, 10),
         perc_inc_auc = (delta_auc)/(init_auc)*100,
         perc_inc_corr = (delta_corr)/(init_corr)*100,
         perc_inc_mse = (delta_mse)/(init_mse)*100,
         perc_imp_auc = ifelse(perc_inc_auc>= p_c, p_c, 
                               ifelse(perc_inc_auc<= -p_c, -p_c, 0)),
         perc_imp_corr = ifelse(perc_inc_corr>=p_c, p_c, 
                                ifelse(perc_inc_corr<= -p_c, -p_c, 0)),
         perc_imp_mse = ifelse(perc_inc_mse<= -p_c, p_c, 
                               ifelse(perc_inc_mse>= p_c, -p_c, 0))) %>% 
  filter(method!='initial') #%>% 
# na.omit

nobvs_pl <- nobvs_pl %>%
  # group_by(uptake, method) %>%
  mutate(nobvs_cat = dplyr::ntile(new_obvs, 10))

```

Going to investigate the amount of improvement against the number of new data points added during the adaptive sampling. First testing with just MSE. 

Cone-shaped again! Going to do the proportion of models that have improved by `r p_c`% for a discretionised number of observations instead.

```{r new_obvs_eval_plot, include = T}

ggplot(subset(nobvs_pl, uptake!=0), aes(x = new_obvs, y = delta_mse)) +
  geom_point() +
  ylab('MSE improvement\n(lower = better)') +
  xlab('Number new observations') +
  facet_wrap(uptake~method, ncol = 6) +
  theme_bw()

ggplot(subset(nobvs_pl, uptake!=0), aes(x = prevalence, y = new_obvs)) +
  geom_point() +
  facet_wrap(uptake~method, ncol = 6) +
  theme_bw()

ggplot(subset(nobvs_pl, uptake!=0), aes(x = new_obvs)) +
  geom_histogram() +
  xlab('Number new observations') +
  facet_wrap(uptake~method, ncol = 6) +
  theme_bw()

```

Investigating Zeros

```{r}

df %>% 
  group_by(community,species,prevalence, uptake, method) %>% 
  summarise(tot = sum(Observed, na.rm = T)) %>% 
  ggplot(aes(x=prevalence, y = tot)) + 
  geom_point() + 
  facet_wrap(method~uptake)



```


Histograms of the number of species with different numbers of observations. These three plots are just three ways of presenting the same data, as I wasn't sure which was the best way to show it.

```{r hists_sightings}

# ggplot(subset(init_new_locs, uptake!=0), aes(x = n)) +
#   geom_histogram() +
#   ylab('Number of species') +
#   facet_wrap(method~uptake, ncol = 3) +
#   theme_bw()

# ggplot(subset(init_new_locs, uptake!=0), aes(x = n, y = method, fill = method)) +
#   geom_density_ridges(stat = "binline", alpha = 0.5) +
#   facet_wrap(~uptake) +
#   theme_bw()

ggplot(na.omit(subset(init_new_locs, uptake!=0)), 
       aes(x = n, y = method, fill = method, colour = method)) +
  geom_density_ridges(stat = "binline", alpha = 0.5) +
  facet_wrap(~uptake) +
  theme_bw() +
  xlab('Number of observations') +
  ylab('Method') +
  theme(text = element_text(size = 10)) +
  scale_fill_viridis_d(option = 'turbo', name = 'Method') +
  scale_colour_viridis_d(option = 'turbo', name = 'Method')


# ggplot(subset(init_new_locs, uptake!=0), aes(x = n, y = method, fill = factor(uptake))) +
#   geom_density_ridges(alpha = 0.5) +
#   theme_bw()

## NAs in plots because couldn't match method - needed to rerun code on jasmin


```

Going to split it up by a 10-level categorical number of new observations. The number of data points is the same in each box for each combination of method x uptake amount. But differ between different method x uptake combinations. First let's check how many data points per category.

```{r plot_nobs_cat, include = T}

nobvs_pl %>% 
  na.omit() %>% 
  group_by(nobvs_cat, uptake, method) %>% 
  tally() %>% 
  filter(uptake != 0) %>% 
  ggplot(aes(nobvs_cat, n, label=n)) +
  geom_point() +
  ylab('Number data points') +
  xlab('Number new observations category') +
  geom_text(hjust=-0.2, vjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  facet_wrap(method~uptake)


# nobvs_pl  %>% 
#   group_by(uptake, method, nobvs_cat) %>% 
#   tally() %>% 
#   ggplot(aes(nobvs_cat, n, label=n)) +
#   geom_point() +
#   ylab('Number data points') +
#   xlab('Number new observations category') +
#   geom_text(hjust=-0.2, vjust=0) +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1))

```


Now we look at the number of models that improve and disimprove by `r p_c`% in each category.

Legend: -`r p_c` = worsened by >`r p_c`%, `r p_c` = improved by >=`r p_c`%, 0 = change in either direction <1%. 


```{r pcchg_plots_new_obs, include = T}

ggplot(na.omit(subset(nobvs_pl, uptake != 0 & method != 'initial')), 
       aes(x = nobvs_cat, fill = factor(perc_imp_auc))) +
  geom_bar(position="fill") +
  scale_fill_discrete(name = 'AUC') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin MSE') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))


ggplot(na.omit(subset(nobvs_pl, uptake != 0 & method != 'initial')), 
       aes(x = nobvs_cat, fill = factor(perc_imp_mse))) +
  geom_bar(position="fill") +
  scale_fill_discrete(name = 'MSE') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin MSE') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))


ggplot(na.omit(subset(nobvs_pl, uptake != 0 & method != 'initial')), 
       aes(x = nobvs_cat, fill = factor(perc_imp_corr))) +
  geom_bar(position="fill") +
  scale_fill_discrete(name = 'Correlation') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin MSE') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))

```

## Percentage change in models

Now we're going to use the same type of plots to investigate the proportion of models changing against prevalence, initial MSE, AUC and Correlation.

First, look at the number of data points per group.

```{r calc_perc_change}

etp <- et %>% 
  # group_by(method, uptake) %>% 
  mutate(prev_cat = dplyr::ntile(prevalence, 10),
         auc_cat = dplyr::ntile(init_auc, 10),
         mse_cat = dplyr::ntile(init_mse, 10),
         corr_cat = dplyr::ntile(init_corr, 10)) %>% 
  # ungroup() %>% 
  # rowwise() %>% 
  mutate(perc_inc_auc = (delta_auc)/(init_auc)*100,
         perc_inc_corr = (delta_corr)/(init_corr)*100,
         perc_inc_mse = (delta_mse)/(init_mse)*100,
         perc_imp_auc = ifelse(perc_inc_auc>= p_c, p_c, 
                               ifelse(perc_inc_auc<= -p_c, -p_c, 0)),
         perc_imp_corr = ifelse(perc_inc_corr>=p_c, p_c, 
                                ifelse(perc_inc_corr<= -p_c, -p_c, 0)),
         perc_imp_mse = ifelse(perc_inc_mse<= -p_c, p_c, 
                               ifelse(perc_inc_mse>= p_c, -p_c, 0)))# 1, 
# ifelse(perc_inc_auc<(-5), -1, 0)))


```


```{r plot_n_obs, include = T}

etp %>% 
  na.omit() %>% 
  group_by(prev_cat, method, uptake) %>% 
  tally() %>% 
  ggplot(aes(prev_cat, n, label=n)) +
  geom_point() +
  ylab('Number data points') +
  xlab('Prevalence category') +
  geom_text(hjust=-0.2, vjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  facet_wrap(method~uptake)

etp %>% 
  na.omit() %>% 
  group_by(auc_cat, method, uptake) %>% 
  tally() %>% 
  ggplot(aes(auc_cat, n, label=n)) +
  geom_point() +
  ylab('Number data points') +
  xlab('AUC category') +
  geom_text(hjust=-0.2, vjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  facet_wrap(method~uptake)

etp %>% 
  na.omit() %>% 
  group_by(mse_cat, method, uptake) %>% 
  tally() %>% 
  ggplot(aes(mse_cat, n, label=n)) +
  geom_point() +
  ylab('Number data points') +
  xlab('MSE category') +
  geom_text(hjust=-0.2, vjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  facet_wrap(method~uptake)

etp %>% 
  na.omit() %>% 
  group_by(corr_cat, method, uptake) %>% 
  tally() %>% 
  ggplot(aes(corr_cat, n, label=n)) +
  geom_point() +
  ylab('Number data points') +
  xlab('Correlation category') +
  geom_text(hjust=-0.2, vjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1))

```

Now look at number of models changing in each of the prevalence categories for all of the uptake values (0.01, 0.1, 0.5).

Prevalence vs proportion of models that changed by >=`r p_c`%. -`r p_c` = worsened by >`r p_c`%, `r p_c` = improved by >=`r p_c`%, 0 = change in either direction <1%. 

```{r plots_prop, include = T}

ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = prev_cat, fill = factor(perc_imp_auc))) +
  geom_bar(position="fill") +
  ylab('Proportion of models') +
  xlab('Prevalence category') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin AUC') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1),
        text = element_text(size = 10))


ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = prev_cat, fill = factor(perc_imp_mse))) +
  geom_bar(position="fill") +
  ylab('Proportion of models') +
  xlab('Prevalence category') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin MSE') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1),
        text = element_text(size = 10))


ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = prev_cat, fill = factor(perc_imp_corr))) +
  geom_bar(position="fill") +
  ylab('Proportion of models') +
  xlab('Prevalence category') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  scale_fill_grey(name = 'Percentage change\nin Correlation') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1),
        text = element_text(size = 10))


```


Raw prevalence plots

```{r raw_prev}


g <- na.omit(subset(etp, uptake != 0 & method != 'initial')) %>% 
  group_by(factor(uptake), method) %>% 
  mutate(med_mse = mean(delta_mse, na.rm = T))

ggplot(g, aes(x = prevalence, y = (delta_mse), col = factor(uptake))) +
  geom_point(alpha = 0.5) +
  # geom_hline(aes(yintercept = 0, linetype = 'Zero')) +
  geom_hline(aes(yintercept = (med_mse), linetype = 'Median')) +
  facet_wrap(~method) +
  theme_bw() 

ggplot(g, aes(x = factor(prev_cat), y = (delta_mse), fill = factor(uptake))) +
  geom_boxplot() +
  # geom_hline(aes(yintercept = 0, linetype = 'Zero')) +
  geom_hline(aes(yintercept = (med_mse), linetype = 'Median')) +
  facet_wrap(~method) +
  theme_bw()

```


Amount of improvement vs performance of initial model.

```{r perf_init_new, include = T}

ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = auc_cat, fill = factor(perc_imp_auc))) +
  geom_bar(position="fill") +
  xlab('Initial model AUC') +
  scale_fill_grey(name = 'Percentage change\nin AUC') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))


ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = mse_cat, fill = factor(perc_imp_mse))) +
  geom_bar(position="fill") +
  xlab('Initial model MSE') +
  scale_fill_grey(name = 'Percentage change\nin MSE') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))


ggplot(na.omit(subset(etp, uptake != 0 & method != 'initial')), 
       aes(x = corr_cat, fill = factor(perc_imp_corr))) +
  geom_bar(position="fill") +
  xlab('Initial model Correlation') +
  scale_fill_grey(name = 'Percentage change\nin Correlation') +
  # ylim(0,0.25) +
  facet_wrap(uptake~method, ncol = 6) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))

```


### Number of models with >X % increase

The number of models that increase by X% could be a good indication of how well each of the adaptive sampling methods perform. The plot below shows the each of the number of models improving for each of the adaptive sampling methods split by each evaluation metric, uptake value and percentage improvement. We considered the number of models improving by 1, 2 and 5%.

```{r n_mods_inc_pc}

# number of models with > x% increase
nmods <- etp %>%
  group_by(community, method, uptake) %>%
  summarise(n_mods_auc_1 = sum(perc_inc_auc>1, na.rm = T),
            n_mods_auc_2 = sum(perc_inc_auc>2, na.rm = T),
            n_mods_auc_5 = sum(perc_inc_auc>5, na.rm = T),
            n_mods_mse_1 = sum(perc_inc_mse< -1, na.rm = T),
            n_mods_mse_2 = sum(perc_inc_mse< -2, na.rm = T),
            n_mods_mse_5 = sum(perc_inc_mse< -5, na.rm = T),
            n_mods_corr_1 = sum(perc_inc_corr>1, na.rm = T),
            n_mods_corr_2 = sum(perc_inc_corr>2, na.rm = T),
            n_mods_corr_5 = sum(perc_inc_corr>5, na.rm = T)) 

head(nmods)

nmods_l <- pivot_longer(nmods, cols = 4:12) %>% 
  rowwise() %>% 
  mutate(eval_type = ifelse(grepl(x = name, pattern = 'auc'), 'auc',
                            ifelse(grepl(x = name, pattern = 'mse'), 'mse', 
                                   ifelse(grepl(x = name, pattern = 'corr'), 'corr', 'WRONG'))),
         inc_amount = as.numeric(gsub("[^\\d]+", "", name, perl=TRUE)))

# number of models with > x% increase
nmods_dec <- etp %>%
  group_by(community, method, uptake) %>%
  summarise(n_mods_dec_auc_1 = sum(perc_inc_auc< -1, na.rm = T),
            n_mods_dec_auc_2 = sum(perc_inc_auc< -2, na.rm = T),
            n_mods_dec_auc_5 = sum(perc_inc_auc< -5, na.rm = T),
            n_mods_dec_mse_1 = sum(perc_inc_mse> 1, na.rm = T),
            n_mods_dec_mse_2 = sum(perc_inc_mse> 2, na.rm = T),
            n_mods_dec_mse_5 = sum(perc_inc_mse> 5, na.rm = T),
            n_mods_dec_corr_1 = sum(perc_inc_corr< -1, na.rm = T),
            n_mods_dec_corr_2 = sum(perc_inc_corr< -2, na.rm = T),
            n_mods_dec_corr_5 = sum(perc_inc_corr< -5, na.rm = T)) 

nmods_dec_l <- pivot_longer(nmods_dec, cols = 4:12) %>% 
  rowwise() %>% 
  mutate(eval_type = ifelse(grepl(x = name, pattern = 'auc'), 'auc',
                            ifelse(grepl(x = name, pattern = 'mse'), 'mse', 
                                   ifelse(grepl(x = name, pattern = 'corr'), 'corr', 'WRONG'))),
         dec_amount = as.numeric(gsub("[^\\d]+", "", name, perl=TRUE)))

```


```{r n_mods_inc_pc_plot, include = T}

ggplot(subset(nmods_l, uptake != 0 & method != 'initial'), 
       aes(x = method, y = value, fill = factor(inc_amount))) +
  geom_boxplot() +
  scale_fill_discrete(name = "% improvement") +
  facet_wrap(eval_type~uptake,nrow = 3) +
  ylab('Number of models') +
  xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(subset(nmods_dec_l, uptake != 0 & method != 'initial'), 
       aes(x = method, y = value, fill = factor(dec_amount))) +
  geom_boxplot() +
  scale_fill_discrete(name = "% disimprovement") +
  facet_wrap(eval_type~uptake,nrow = 3) +
  ylab('Number of models') +
  xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# ggplot(subset(nmods_l, uptake != 0 & inc_amount == 1 & method != 'initial'),
#        aes(x = method, y = value, fill = factor(uptake))) +
#   geom_boxplot() +
#   scale_fill_discrete(name = "Proportion uptake") +
#   facet_wrap(inc_amount~eval_type,ncol = 3) +
#   ylab('Number of models') +
#   xlab('') +
#   ggtitle('Number of models with 1% improvement for different uptake values') +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


```{r aggregate_community}

## average across communities
comm_df <- et %>%
  group_by(community, method, uptake) %>%
  summarise(mse = mean(mse, na.rm = T),
            corr = mean(corr, na.rm = T),
            auc = mean(auc, na.rm = T),
            mean_sd = mean(mean_sd, na.rm = T),
            max_sd = max(max_sd, na.rm = T),
            prev = median(prevalence, na.rm = T),
            init_mse = mean(init_mse, na.rm = T),
            init_corr = mean(init_corr, na.rm = T),
            init_auc = mean(init_auc, na.rm = T),
            init_mean_sd = mean(init_mean_sd, na.rm = T),
            init_max_sd = max(init_max_sd, na.rm = T),
            prev = median(prev)) %>%
  ungroup() %>% 
  mutate(delta_mse = sqrt(mse) - sqrt(init_mse),
         delta_corr = corr - init_corr,
         delta_auc = auc - init_auc,
         delta_mean_sd = mean_sd - init_mean_sd,
         delta_max_sd = max_sd - init_max_sd)

comm_df_l <- comm_df %>% 
  dplyr::filter(method!='initial', uptake!=0) %>% 
  dplyr::select(community, method, uptake, mse = delta_mse, corr = delta_corr, auc = delta_auc) %>% 
  pivot_longer(cols = 4:6)
head(comm_df_l)

```

For this final plot, the top row shows community level change in performance plots for each adaptive sampling method and evaluation metric. The bottom row shows the number of models that have increased by >1% and different levels of uptake for each adaptive sampling method and evaluation metric.  

```{r community_pls_numb_model_plot, include = T}

## community results
cpl_comm <- ggplot(comm_df_l, aes(x=method, y = value, fill = factor(uptake))) +
  geom_boxplot() +
  scale_fill_discrete(name = "Uptake") +
  facet_wrap(~name) +
  theme_bw() +
  ylab('Change in model performance\n(new - initial)') +
  xlab('') +
  theme(axis.text.x = element_blank())#element_text(angle = 45, hjust = 1))

## number model plots
nmods_pl <- ggplot(subset(nmods_l, uptake != 0 & inc_amount == 1 & method != 'initial'), 
                   aes(x = method, y = value, fill = factor(uptake))) +
  geom_boxplot() +
  scale_fill_discrete(name = "Uptake") +
  facet_wrap(~eval_type,ncol = 3) +
  ylab('Number of models\n>1% improvement') +
  xlab('') +
  # ggtitle('Number of models with 1% improvement for different uptake values') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

cpl_comm/nmods_pl + plot_layout(guides = 'collect')

```


```{r comm_plots_mse_auc_corr, echo = FALSE}

cno1 <- ggplot(comm_df[comm_df$method!='initial' & comm_df$uptake!=0,] %>% 
                 mutate(facet = 'MSE'), 
               aes(x=method, y = delta_mse, fill = factor(uptake))) +
  geom_boxplot() +
  theme_bw() + 
  ylim(-0.008, 0.005) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  xlab('') + ylab('Delta MSE (lower = better)') +
  theme(axis.text.x = element_blank()) +
  scale_fill_discrete(name = 'Uptake') +
  facet_wrap(~facet)


cno2 <- ggplot(comm_df[comm_df$method!='initial' & comm_df$uptake!=0,] %>% 
                 mutate(facet = 'AUC'), 
               aes(x=method, y = delta_auc, fill = factor(uptake))) +
  geom_boxplot() +
  theme_bw() + 
  ylim(-0.005, 0.009) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  xlab('') + ylab('Delta AUC (higher = better)') +
  theme(axis.text.x = element_blank()) +
  scale_fill_discrete(name = 'Uptake') +
  facet_wrap(~facet)


cno3 <- ggplot(comm_df[comm_df$method!='initial' & comm_df$uptake!=0,] %>% 
                 mutate(facet = 'Correlation'), 
               aes(x=method, y = delta_corr, fill = factor(uptake))) +
  geom_boxplot() +
  theme_bw() + 
  ylim(-0.015, 0.02) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  xlab('') + ylab('Delta corr. (higher = better)') +
  theme(axis.text.x = element_blank()) +
  scale_fill_discrete(name = 'Uptake') +
  facet_wrap(~facet)

comb_plot_comm_no <- cno1+cno2+cno3 + plot_layout(guides = 'collect')
comb_plot_comm_no

```


```{r n_mods_pl}


msen <- ggplot(subset(nmods_l, uptake != 0 & inc_amount == 1 & method != 'initial' & eval_type == 'mse'), 
               aes(x = method, y = value, fill = factor(uptake))) +
  geom_boxplot() +
  scale_fill_discrete(name = "Uptake") +
  # facet_wrap(~eval_type,ncol = 3) +
  ylab('Number of models\n>1% improvement') +
  xlab('') +
  # ggtitle('Number of models with 1% improvement for different uptake values') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) 

aucn <- ggplot(subset(nmods_l, uptake != 0 & inc_amount == 1 & method != 'initial' & eval_type == 'auc'), 
               aes(x = method, y = value, fill = factor(uptake))) +
  geom_boxplot() +
  scale_fill_discrete(name = "Uptake") +
  # facet_wrap(~eval_type,ncol = 3) +
  ylab('Number of models\n>1% improvement') +
  xlab('') +
  # ggtitle('Number of models with 1% improvement for different uptake values') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

corrn <- ggplot(subset(nmods_l, uptake != 0 & inc_amount == 1 & method != 'initial' & eval_type == 'corr'), 
                aes(x = method, y = value, fill = factor(uptake))) +
  geom_boxplot() +
  scale_fill_discrete(name = "Uptake") +
  # facet_wrap(~eval_type,ncol = 3) +
  ylab('Number of models\n>1% improvement') +
  xlab('') +
  # ggtitle('Number of models with 1% improvement for different uptake values') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

nmods_c <- (cno1+cno2+cno3) / (msen + aucn + corrn) + 
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a') +
  theme(text = element_text(angle = 45, hjust = 1, size = 10))
nmods_c 

```


```{r mse_only, fig.width=5, fig.height = 6}

cno1 / msen + plot_layout(guides = 'collect')

```

